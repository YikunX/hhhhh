version: 0.2

env:
  secrets-manager:
    CLAVIN_MAVEN_CENTRAL_USERNAME: "CLAVIN:MAVEN_CENTRAL_USERNAME"
    CLAVIN_MAVEN_CENTRAL_PASSWORD: "CLAVIN:MAVEN_CENTRAL_PASSWORD"

phases:
  install:
    commands:
      - uname -a
      - yum update -y
      - echo list available openjdk packages
      - yum list *openjdk*
      - echo install openjdk packages
      - yum install -y java-14-openjdk-devel java-14-openjdk-jmods
      - echo show default java version
      - echo $JAVA_HOME
      - java -version
      - cd /usr/lib/jvm
      - ls
      - export JAVA_HOME=/usr/lib/jvm/java-openjdk
      - cd $JAVA_HOME/bin
      - java -version
      - echo configure java command
      - alternatives --install /usr/bin/java java /usr/lib/jvm/java-openjdk/bin/java 20000
      - alternatives --set java /usr/lib/jvm/java-openjdk/bin/java
      - alternatives --display java
      - echo configure javac command
      - alternatives --install /usr/bin/javac javac /usr/lib/jvm/java-openjdk/bin/javac 20000
      - alternatives --set javac /usr/lib/jvm/java-openjdk/bin/javac
      - alternatives --display javac
      - echo show updated java version
      - java -version
      - cd $CODEBUILD_SRC_DIR

  pre_build:
    commands:
      - pip3 install awscli --upgrade --user

  build:
    commands:
      - export UNAME=$CLAVIN_MAVEN_CENTRAL_USERNAME
      - export PWORD=$CLAVIN_MAVEN_CENTRAL_PASSWORD
      - cd ../
      - curl -O http://download.geonames.org/export/dump/allCountries.zip 
      - unzip allCountries.zip 
      - mvn -B compile 
      - MAVEN_OPTS="-Xmx4g" mvn exec:java -Dexec.mainClass="com.novetta.clavin.index.IndexDirectoryBuilder"       
      - mvn -s settings.xml clean package deploy
